<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreHub — Inventory Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *,:before,:after{box-sizing:border-box;margin:0;padding:0}
        :root{
            --bg:#fafaf9;--surface:#ffffff;--surface-alt:#f5f5f4;--border:#e7e5e4;
            --text:#1c1917;--text-secondary:#78716c;--text-muted:#a8a29e;
            --accent:#ea580c;--accent-hover:#c2410c;--accent-light:#fff7ed;--accent-subtle:#fed7aa;
            --danger:#dc2626;--danger-light:#fef2f2;
            --success:#16a34a;--success-light:#f0fdf4;
            --warn:#d97706;--warn-light:#fffbeb;
            --radius:10px;--shadow:0 1px 3px rgba(28,25,23,.06),0 1px 2px rgba(28,25,23,.04);
            --shadow-md:0 4px 12px rgba(28,25,23,.08);
        }
        body{font-family:'Space Grotesk',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
        body::before{content:'';position:fixed;inset:0;z-index:-1;
            background-image:radial-gradient(circle,#d6d3d1 1px,transparent 1px);
            background-size:24px 24px;opacity:.5}

        header{background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
        .header-inner{max-width:1280px;margin:0 auto;padding:0 24px;height:64px;display:flex;align-items:center;justify-content:space-between}
        .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.25rem;color:var(--text);text-decoration:none}
        .logo-mark{width:34px;height:34px;background:var(--accent);border-radius:8px;display:grid;place-items:center;color:#fff;font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:600}
        .header-actions{display:flex;align-items:center;gap:12px}
        .health-dot{width:8px;height:8px;border-radius:50%;background:#16a34a;box-shadow:0 0 0 3px rgba(22,163,74,.2);margin-right:4px}
        .health-label{font-size:.8rem;color:var(--text-secondary);font-weight:500}
        .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius);font-family:inherit;font-size:.875rem;font-weight:600;cursor:pointer;border:none;transition:all .15s ease}
        .btn-primary{background:var(--accent);color:#fff}
        .btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:var(--shadow-md)}
        .btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid var(--border)}
        .btn-ghost:hover{background:var(--surface-alt);color:var(--text)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-danger:hover{background:#b91c1c}
        .btn-sm{padding:6px 12px;font-size:.8rem}

        main{max-width:1280px;margin:0 auto;padding:24px}

        .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
        .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);transition:box-shadow .15s}
        .stat-card:hover{box-shadow:var(--shadow-md)}
        .stat-label{font-size:.78rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
        .stat-value{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:600;color:var(--text)}
        .stat-card.highlight{border-left:3px solid var(--accent);background:var(--accent-light)}
        .stat-card.warn-card{border-left:3px solid var(--warn);background:var(--warn-light)}

        .toolbar{display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap}
        .search-box{flex:1;min-width:200px;position:relative}
        .search-box input{width:100%;padding:10px 14px 10px 38px;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:.875rem;background:var(--surface);color:var(--text);transition:border-color .15s}
        .search-box input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(234,88,12,.1)}
        .search-box svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted);width:16px;height:16px}
        .search-box input::placeholder{color:var(--text-muted)}

        .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        thead{background:var(--surface-alt)}
        th{padding:12px 16px;text-align:left;font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid var(--border)}
        td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:.875rem;vertical-align:middle}
        tbody tr{transition:background .1s}
        tbody tr:hover{background:var(--surface-alt)}
        tbody tr:last-child td{border-bottom:none}
        .product-name{font-weight:600;color:var(--text)}
        .product-desc{color:var(--text-secondary);font-size:.8rem;margin-top:2px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .mono{font-family:'JetBrains Mono',monospace;font-size:.85rem}
        .stock-badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:999px;font-size:.75rem;font-weight:600}
        .stock-ok{background:var(--success-light);color:var(--success)}
        .stock-low{background:var(--warn-light);color:var(--warn)}
        .stock-out{background:var(--danger-light);color:var(--danger)}
        .actions-cell{display:flex;gap:6px}
        .icon-btn{width:32px;height:32px;display:grid;place-items:center;border-radius:8px;border:1px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text-secondary);transition:all .12s}
        .icon-btn:hover{background:var(--surface-alt);color:var(--text)}
        .icon-btn.del:hover{background:var(--danger-light);color:var(--danger);border-color:var(--danger)}
        .icon-btn svg{width:15px;height:15px}

        .pagination{display:flex;justify-content:space-between;align-items:center;margin-top:16px;font-size:.85rem;color:var(--text-secondary)}
        .page-btns{display:flex;gap:6px}

        .modal-backdrop{position:fixed;inset:0;background:rgba(28,25,23,.4);z-index:100;display:none;place-items:center;animation:fadeIn .15s}
        .modal-backdrop.show{display:grid}
        .modal{background:var(--surface);border-radius:14px;box-shadow:0 20px 60px rgba(28,25,23,.18);width:min(480px,92vw);padding:28px;animation:slideUp .2s ease}
        .modal h2{font-size:1.15rem;font-weight:700;margin-bottom:20px;color:var(--text)}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:.78rem;font-weight:600;color:var(--text-secondary);margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em}
        .form-group input,.form-group textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:.875rem;background:var(--surface);color:var(--text);transition:border-color .15s}
        .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(234,88,12,.1)}
        .form-group textarea{resize:vertical;min-height:70px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}

        .toast-area{position:fixed;bottom:24px;right:24px;z-index:200;display:flex;flex-direction:column-reverse;gap:8px}
        .toast{padding:12px 18px;border-radius:var(--radius);font-size:.85rem;font-weight:500;color:#fff;box-shadow:var(--shadow-md);animation:slideIn .25s ease;min-width:240px}
        .toast.ok{background:#16a34a}
        .toast.err{background:#dc2626}
        .toast.removing{animation:slideOut .2s ease forwards}
        .empty-state{text-align:center;padding:64px 24px;color:var(--text-muted)}
        .empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
        .empty-state p{font-size:.95rem}
        .spinner{width:18px;height:18px;border:2.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin:40px auto}

        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
        @keyframes slideOut{to{opacity:0;transform:translateX(40px)}}
        @keyframes spin{to{transform:rotate(360deg)}}

        @media(max-width:768px){
            .stats-row{grid-template-columns:1fr 1fr}
            .toolbar{flex-direction:column;align-items:stretch}
            .search-box{min-width:100%}
            .form-row{grid-template-columns:1fr}
            .header-inner{padding:0 16px}
            main{padding:16px}
            th:nth-child(3),td:nth-child(3){display:none}
        }
        @media(max-width:480px){
            .stats-row{grid-template-columns:1fr}
            th:nth-child(5),td:nth-child(5){display:none}
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <a href="/" class="logo">
                <div class="logo-mark">SH</div>
                StoreHub
            </a>
            <div class="header-actions">
                <span class="health-dot" id="healthDot"></span>
                <span class="health-label" id="healthLabel">Connecting...</span>
                <button class="btn btn-primary" onclick="openModal()">
                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Product
                </button>
            </div>
        </div>
    </header>

    <main>
        <div class="stats-row" id="statsRow">
            <div class="stat-card highlight">
                <div class="stat-label">Total Products</div>
                <div class="stat-value" id="statProducts">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Units in Stock</div>
                <div class="stat-value" id="statStock">—</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Portfolio Value</div>
                <div class="stat-value" id="statValue">—</div>
            </div>
            <div class="stat-card warn-card">
                <div class="stat-label">Low Stock Alerts</div>
                <div class="stat-value" id="statLow">—</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="searchInput" placeholder="Search by name or description...">
            </div>
            <button class="btn btn-ghost btn-sm" onclick="fetchProducts()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                Refresh
            </button>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Description</th>
                        <th>Stock</th>
                        <th>Added</th>
                        <th style="width:90px"></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="6"><div class="spinner"></div></td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <span id="pageInfo">Loading...</span>
            <div class="page-btns">
                <button class="btn btn-ghost btn-sm" id="prevBtn" onclick="changePage(-1)" disabled>Previous</button>
                <button class="btn btn-ghost btn-sm" id="nextBtn" onclick="changePage(1)" disabled>Next</button>
            </div>
        </div>
    </main>

    <div class="modal-backdrop" id="modalBackdrop" onclick="closeOnBackdrop(event)">
        <div class="modal">
            <h2 id="modalTitle">Add New Product</h2>
            <form id="productForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="fname">Product Name</label>
                    <input type="text" id="fname" required maxlength="100" placeholder="e.g. MacBook Pro 16&quot;">
                </div>
                <div class="form-group">
                    <label for="fdesc">Description</label>
                    <textarea id="fdesc" maxlength="255" placeholder="Brief product description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fprice">Price ($)</label>
                        <input type="number" id="fprice" step="0.01" min="0" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="fstock">Quantity</label>
                        <input type="number" id="fstock" min="0" required placeholder="0">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Create Product</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-area" id="toastArea"></div>

<script>
const API = '/api';
let currentPage = 1;
let totalPages = 1;
let searchTimeout;

document.getElementById('searchInput').addEventListener('input', e => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => { currentPage = 1; fetchProducts(); }, 300);
});

async function fetchProducts() {
    const search = document.getElementById('searchInput').value.trim();
    const params = new URLSearchParams({ page: currentPage, limit: 10 });
    if (search) params.set('search', search);

    try {
        const res = await fetch(`${API}/products?${params}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        const d = json.data;
        totalPages = d.total_pages || 1;
        renderTable(d.products || []);
        renderPagination(d);
    } catch (err) {
        toast('Failed to load products: ' + err.message, 'err');
    }
}

function renderTable(products) {
    const tbody = document.getElementById('tableBody');
    if (!products.length) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            <p>No products found</p></div></td></tr>`;
        return;
    }

    tbody.innerHTML = products.map(p => {
        const stockClass = p.stock_quantity === 0 ? 'stock-out' : p.stock_quantity <= 10 ? 'stock-low' : 'stock-ok';
        const stockLabel = p.stock_quantity === 0 ? 'Out of stock' : p.stock_quantity <= 10 ? 'Low stock' : 'In stock';
        const date = new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        return `<tr>
            <td><div class="product-name">${esc(p.name)}</div></td>
            <td class="mono">$${Number(p.price).toLocaleString('en-US',{minimumFractionDigits:2})}</td>
            <td><div class="product-desc">${esc(p.description || '—')}</div></td>
            <td><span class="stock-badge ${stockClass}">${p.stock_quantity} · ${stockLabel}</span></td>
            <td style="color:var(--text-secondary);font-size:.8rem">${date}</td>
            <td><div class="actions-cell">
                <button class="icon-btn" title="Edit" onclick='editProduct(${JSON.stringify(p)})'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="icon-btn del" title="Delete" onclick="deleteProduct(${p.id},'${esc(p.name)}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div></td>
        </tr>`;
    }).join('');
}

function renderPagination(d) {
    document.getElementById('pageInfo').textContent =
        `Showing ${d.products?.length || 0} of ${d.total} products · Page ${d.page} of ${d.total_pages || 1}`;
    document.getElementById('prevBtn').disabled = d.page <= 1;
    document.getElementById('nextBtn').disabled = d.page >= (d.total_pages || 1);
}

function changePage(dir) {
    currentPage += dir;
    fetchProducts();
}

async function fetchStats() {
    try {
        const res = await fetch(`${API}/stats`);
        const json = await res.json();
        if (!json.success) return;
        const s = json.data;
        document.getElementById('statProducts').textContent = s.total_products.toLocaleString();
        document.getElementById('statStock').textContent = s.total_stock.toLocaleString();
        document.getElementById('statValue').textContent = '$' + Number(s.total_value).toLocaleString('en-US',{minimumFractionDigits:2});
        document.getElementById('statLow').textContent = s.low_stock_count;
    } catch {}
}

async function checkHealth() {
    try {
        const res = await fetch('/health');
        const json = await res.json();
        const dot = document.getElementById('healthDot');
        const label = document.getElementById('healthLabel');
        if (json.success) {
            dot.style.background = '#16a34a';
            dot.style.boxShadow = '0 0 0 3px rgba(22,163,74,.2)';
            label.textContent = 'System Healthy';
        }
    } catch {
        document.getElementById('healthDot').style.background = '#dc2626';
        document.getElementById('healthLabel').textContent = 'Offline';
    }
}

function openModal(product) {
    document.getElementById('editId').value = product?.id || '';
    document.getElementById('fname').value = product?.name || '';
    document.getElementById('fdesc').value = product?.description || '';
    document.getElementById('fprice').value = product?.price ?? '';
    document.getElementById('fstock').value = product?.stock_quantity ?? '';
    document.getElementById('modalTitle').textContent = product ? 'Edit Product' : 'Add New Product';
    document.getElementById('submitBtn').textContent = product ? 'Save Changes' : 'Create Product';
    document.getElementById('modalBackdrop').classList.add('show');
    document.getElementById('fname').focus();
}

function closeModal() {
    document.getElementById('modalBackdrop').classList.remove('show');
    document.getElementById('productForm').reset();
    document.getElementById('editId').value = '';
}

function closeOnBackdrop(e) {
    if (e.target === e.currentTarget) closeModal();
}

function editProduct(p) { openModal(p); }

async function handleSubmit(e) {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const body = {
        name: document.getElementById('fname').value.trim(),
        description: document.getElementById('fdesc').value.trim(),
        price: parseFloat(document.getElementById('fprice').value),
        stock_quantity: parseInt(document.getElementById('fstock').value, 10)
    };

    try {
        const url = id ? `${API}/products/${id}` : `${API}/products`;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        toast(id ? 'Product updated' : 'Product created', 'ok');
        closeModal();
        fetchProducts();
        fetchStats();
    } catch (err) {
        toast(err.message, 'err');
    }
}

async function deleteProduct(id, name) {
    if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
    try {
        const res = await fetch(`${API}/products/${id}`, { method: 'DELETE' });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        toast('Product deleted', 'ok');
        fetchProducts();
        fetchStats();
    } catch (err) {
        toast(err.message, 'err');
    }
}

function toast(msg, type) {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.getElementById('toastArea').appendChild(t);
    setTimeout(() => { t.classList.add('removing'); setTimeout(() => t.remove(), 200); }, 3000);
}

function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

fetchProducts();
fetchStats();
checkHealth();
setInterval(fetchStats, 30000);
setInterval(checkHealth, 60000);
</script>
</body>
</html>
